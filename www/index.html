<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Geo Location</title>
<style type="text/css">
html { height: 100% }
body { height: 100%; margin: 0; padding: 0 }
#map-canvas { height: 100% }

#top{
 background:white;
 width:100%;
}
</style>
        <script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?v=3&key=AIzaSyBPNK3Zb3cbPdLPzSIZehmdz09_udfyjQ8&sensor=false&language=en&libraries=places"></script>
<script type="text/javascript">
google.maps.event.addDomListener(window, 'load', getLocation);
 var mapOptions;
 var newcenter;
 var map;
 var radius = 100;
 var type = 'stores';
 var selection = 0;
function getLocation(){
	navigator.geolocation.getCurrentPosition(onSuccess, onError, { timeout: 15000 });
    
    
}

google.maps.event.addListenerOnce(map, 'idle', function(){
		getLocation2();
});

function onSuccess(position) {
	console.log("refresh");	
    var lat=position.coords.latitude;
    var lang=position.coords.longitude;

    //Google Maps
    var myLatlng = new google.maps.LatLng(lat,lang);
	map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
	mapOptions = {zoom: 15,center: myLatlng};
    var marker = new google.maps.Marker({position: myLatlng,map: map});

	setTimeout(getLocation2, 5000);

}

function getLocation2() {
	navigator.geolocation.getCurrentPosition(update, onError,{ timeout: 15000 });
	}
function update(position) {
	console.log("refresh");	
    var lat=position.coords.latitude;
    var lang=position.coords.longitude;

    //Google Maps
    var myLatlng = new google.maps.LatLng(lat,lang);
	var newcenter = map.getCenter();
	mapOptions = {zoom: 15,center: myLatlng};
	if(newcenter != undefined)mapOptions = {zoom: 15,center: newcenter};
	
	map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
	
	var marker = new google.maps.Marker({position: myLatlng,map: map});		
	
	if(selection == 1){
	places(myLatlng, radius, type);
	}
	
	setTimeout(getLocation2, 7000);


}

function places(myLatlng,b,c){

infowindow = new google.maps.InfoWindow();
        var service = new google.maps.places.PlacesService(map);
        service.nearbySearch({
          location: myLatlng,
          radius: b,
          type: [c]
        }, callback);
      }


 function callback(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          for (var i = 0; i < results.length; i++) {
            createMarker(results[i]);
          }
        }
      }

	  
	  
var iconBase = 'https://maps.google.com/mapfiles/kml/shapes/';
var icons = {
  parking: {
	icon: iconBase + 'parking_lot_maps.png'
  },
  library: {
	icon: iconBase + 'library_maps.png'
  },
  info: {
	icon: iconBase + 'info-i_maps.png'
  }
};
	  
	  
function createMarker(place) {
  var placeLoc = place.geometry.location;
  var markers = new google.maps.Marker({
    map: map,
	//icon: icons[feature.type].icon,
	//icon: 'place.png',
    position: place.geometry.location
  });

google.maps.event.addListener(markers, 'click', function() {
    infowindow.setContent(place.name);
    infowindow.open(map, this);
  });
}

	  
function onError(error) {
    console.log('code: ' + error.code + '\n' +'message: ' + error.message + '\n');
	getLocation();
}


</script>
</head>
<body>
<div id="top" onclick="hideshow(1)">
	
	<div onclick="showmenu(1)">
		V
	</div>
	
</div>
<div id="side">
	<div onclick="showplaces(1)">
		Show places
	</div>
	<div>
		<input type="number" id="radius" placeholder="Radio en metros">
		<input type="button" onclick="updateradius(1)" value="Actualizar">
		<input type="button" id="activate" onclick="updateradius(1)" value="Buscar sitios">
	</div>
</div>
<div id="places">
	<div class="buttonplace" name="liquor_store">Licor</div>
	<div class="buttonplace" name="bank">Banco</div>
	<div class="buttonplace" name="night_club">Club Nocturno</div>
	<div class="buttonplace" name="museum">Museo</div>
	<div class="buttonplace" name="restaurant">Restaurants</div>
	<div class="buttonplace" name="hospital">Hospital</div>
</div>
<div id="map-canvas"></div>



<script>
	function showmenu(a){
		
	}
	
	
	$( ".buttonplace" ).click(function() {
	console.log($( this ).attr( "name" ));
		type = $( this ).attr( "name" );
	});
	
	$( ".gm-style-iw" ).click(function() {
		$( this ).children( ".selected" )
		type = $( this ).attr( "name" );
	});
	
	function updateradius(a){
		radius	= parseInt($("#radius").val());
		if(a==1){
		$("#activate").val("Parar de buscar");
		$( "#activate" ).attr( "onclick" ,"updateradius(0)");
		selection = 1;
		}
		if(a==0){
		$("#activate").val("Buscar sitios");
		$( "#activate" ).attr( "onclick" ,"updateradius(1)");
		selection = 0;
		}
	}
	
</script>

</body>
</html>